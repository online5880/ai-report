<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>학습 결과 지식 그래프</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
      body {
        font-family: 'Noto Sans KR', sans-serif;
        margin: 0;
        padding: 20px;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .score-display {
        font-size: 1.2em;
        margin-bottom: 20px;
        padding: 15px;
        background-color: #f8fafc;
        border-radius: 8px;
        border-left: 4px solid #3498db;
      }

      #knowledge-graph {
        width: 100%;
        height: 600px;
        border: 1px solid #ccc;
        border-radius: 8px;
        margin-top: 20px;
        position: relative;
      }

      .node {
        stroke: #fff;
        stroke-width: 1.5px;
      }

      .label {
        font-size: 12px;
        font-family: sans-serif;
      }

      .btn {
        padding: 10px 20px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        text-decoration: none;
        font-size: 1em;
      }

      .btn:hover {
        background-color: #2980b9;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>학습 결과 분석</h1>
      <a href="/calendar/{{ user_id }}/" class="btn">캘린더로 돌아가기</a>
    </div>

    <div class="score-display">
      점수: {{ score }} / {{ total }}
    </div>

    <div id="knowledge-graph"></div>

    <script>
      // 지식 그래프를 가져와 렌더링하는 함수
      async function fetchAndRenderKnowledgeGraph() {
        try {
          // 서버에서 전달받은 predictions 데이터를 JavaScript 객체로 파싱
          const predictionsData = {{ predictions | safe }};
          console.log("Predictions:", predictionsData);

          // predictions 데이터 변환
          const flattenedPredictions = predictionsData.predictions.map((entry) =>
            Object.entries(entry).map(([id, value]) => ({ [id]: value }))
          ).flat();
          console.log("Flattened Predictions:", flattenedPredictions);

          // Step 1: 추천 API 호출
          const recommendResponse = await fetch(
            "http://mane.my/api/graphsage/recommend",
            {
              method: "POST",
              headers: {
                accept: "application/json",
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                predictions: flattenedPredictions,
                top_k: 3,
              }),
            }
          );

          if (!recommendResponse.ok) {
            throw new Error(`Recommend API error: ${recommendResponse.status}`);
          }

          const recommendData = await recommendResponse.json();
          console.log("Recommend API Response:", recommendData);

          // f_mchapter_id 추출
          const f_mchapter_ids = [
            ...new Set(
              recommendData.recommendations.flatMap((r) => [
                ...r.target.map((t) => t.f_mchapter_id),
                ...r.similar.map((s) => s.f_mchapter_id),
              ])
            ),
          ];
          console.log("Unique f_mchapter_ids:", f_mchapter_ids);

          // Step 2: 지식 그래프 데이터 API 호출
          const graphResponse = await fetch(
            "http://mane.my/api/graph-data/",
            {
              method: "POST",
              headers: {
                accept: "application/json",
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ message: f_mchapter_ids.join(", ") }),
            }
          );

          if (!graphResponse.ok) {
            throw new Error(`Graph-data API error: ${graphResponse.status}`);
          }

          const graphData = await graphResponse.json();
          console.log("Graph Data:", graphData);

          // Step 3: 그래프 렌더링
          renderGraph(graphData);
        } catch (error) {
          console.error("Error in fetchAndRenderKnowledgeGraph:", error);
          document.getElementById("knowledge-graph").innerHTML =
            '<p style="color: red;">지식 그래프를 불러오는데 실패했습니다: ' +
            error.message +
            "</p>";
        }
      }

      // 그래프 렌더링 함수
      function renderGraph(graphData) {
        // 그래프 초기화
        d3.select("#knowledge-graph svg").remove();

        const width = document.getElementById("knowledge-graph").clientWidth;
        const height = 600;

        const svg = d3
          .select("#knowledge-graph")
          .append("svg")
          .attr("width", width)
          .attr("height", height)
          .call(
            d3.zoom().on("zoom", function (event) {
              svg.attr("transform", event.transform);
            })
          )
          .append("g");

        svg
          .append("defs")
          .append("marker")
          .attr("id", "arrowhead")
          .attr("viewBox", "-0 -5 10 10")
          .attr("refX", 15)
          .attr("refY", 0)
          .attr("orient", "auto")
          .attr("markerWidth", 6)
          .attr("markerHeight", 6)
          .append("svg:path")
          .attr("d", "M 0,-5 L 10 ,0 L 0,5")
          .attr("fill", "#999");

        const simulation = d3
          .forceSimulation(graphData.nodes)
          .force(
            "link",
            d3.forceLink(graphData.links).id((d) => d.id).distance(100)
          )
          .force("charge", d3.forceManyBody().strength(-300))
          .force("center", d3.forceCenter(width / 2, height / 2));

        const link = svg
          .append("g")
          .selectAll("line")
          .data(graphData.links)
          .enter()
          .append("line")
          .attr("stroke", "#aaa")
          .attr("stroke-width", 2)
          .attr("marker-end", "url(#arrowhead)");

        const node = svg
          .append("g")
          .selectAll("circle")
          .data(graphData.nodes)
          .enter()
          .append("circle")
          .attr("r", 10)
          .attr("fill", (d) => d.color || "#cccccc")
          .call(
            d3
              .drag()
              .on("start", function (event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
              })
              .on("drag", function (event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
              })
              .on("end", function (event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
              })
          );

        const label = svg
          .append("g")
          .selectAll("text")
          .data(graphData.nodes)
          .enter()
          .append("text")
          .attr("class", "label")
          .text((d) => d.label)
          .attr("font-size", "12px")
          .attr("dx", 12)
          .attr("dy", 4);

        simulation.nodes(graphData.nodes).on("tick", function () {
          link
            .attr("x1", (d) => d.source.x)
            .attr("y1", (d) => d.source.y)
            .attr("x2", (d) => d.target.x)
            .attr("y2", (d) => d.target.y);

          node.attr("cx", (d) => d.x).attr("cy", (d) => d.y);

          label.attr("x", (d) => d.x).attr("y", (d) => d.y);
        });

        simulation.force("link").links(graphData.links);
      }

      // 페이지 로드 시 그래프를 자동으로 로드
      document.addEventListener("DOMContentLoaded", fetchAndRenderKnowledgeGraph);
    </script>
  </body>
</html>
